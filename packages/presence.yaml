################################################################
## Packages / Presence
################################################################

################################################
## Customize
################################################

homeassistant:
  customize:
    ################################################
    ## Node Anchors
    ################################################

    package.node_anchors:
      customize: &customize
        package: 'presence'

      expose: &expose
        <<: *customize
        homebridge_hidden: true

    ################################################
    ## Automation
    ################################################

    automation.person_arriving:
      <<: *expose
      friendly_name: "Mark person as just arrived"
      icon: mdi:map-marker

    automation.person_home:
      <<: *expose
      friendly_name: "Mark person as home"
      icon: mdi:map-marker

    automation.person_departing:
      <<: *expose
      friendly_name: "Mark person as just left"
      icon: mdi:map-marker

    automation.person_away:
      <<: *expose
      friendly_name: "Mark person as away"
      icon: mdi:map-marker

    automation.person_vacation:
      <<: *expose
      friendly_name: "Mark person as extended away"
      icon: mdi:map-marker

    ################################################
    ## Binary Sensor
    ################################################

    binary_sensor.julia_home:
      <<: *customize
      status_select: input_select.julias_status

    binary_sensor.michael_home:
      <<: *customize
      status_select: input_select.michaels_status

    ################################################
    ## Input Select
    ################################################

    input_select.julias_status:
      <<: *customize
      friendly_name: "Julia"
      entity_picture: /local/img/julia.jpg

    input_select.michaels_status:
      <<: *customize
      friendly_name: "Michael"
      entity_picture: /local/img/michael.jpg

    ################################################
    ## Sensor
    ################################################

    sensor.household:
      <<: *customize
      friendly_name: "Household"

################################################
## Binary Sensor
################################################

binary_sensor:
  - platform: 'bayesian'
    name: 'julia_home'
    prior: 0.76
    probability_threshold: 0.98
    observations:
      - entity_id: 'device_tracker.julia_ios'
        prob_given_true: 0.90
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.julia_life360'
        prob_given_true: 0.99
        platform: 'state'
        to_state: 'home'

  - platform: 'bayesian'
    name: 'michael_home'
    prior: 0.73
    probability_threshold: 0.98
    observations:
      - entity_id: 'device_tracker.michael_ios'
        prob_given_true: 0.90
        platform: 'state'
        to_state: 'home'
      - entity_id: 'device_tracker.michael_life360'
        prob_given_true: 0.99
        platform: 'state'
        to_state: 'home'

################################################
## Input Select
################################################

input_select:
  julias_status:
    options:
      - Home
      - Arriving
      - Departing
      - Away
      - Vacation

  michaels_status:
    options:
      - Home
      - Arriving
      - Departing
      - Away
      - Vacation

################################################
## Sensor
################################################

sensor:
  - platform: template
    sensors:
      household:
        entity_id:
          - input_select.julias_status
          - input_select.michaels_status
        value_template: >-
          {% if is_state('input_select.julias_status', 'Home') or is_state('input_select.michaels_status', 'Home') %}
            Home
          {% elif is_state('input_select.julias_status', 'Arriving') or is_state('input_select.michaels_status', 'Arriving') %}
            Arriving
          {% elif is_state('input_select.julias_status', 'Departing') or is_state('input_select.michaels_status', 'Departing') %}
            Departing
          {% elif is_state('input_select.julias_status', 'Vacation') and is_state('input_select.michaels_status', 'Vacation') %}
            Vacation
          {% else %}
            Away
          {% endif %}
        icon_template: >-
          {% set household_status = states('sensor.household') %}
          {% if household_status == 'Home' or household_status == 'Arriving' %}
            mdi:map-marker-radius
          {% elif household_status == 'Vacation' %}
            mdi:beach
          {% else %}
            mdi:car
          {% endif %}

################################################
## Automation
################################################

automation:
  - alias: person_arriving
    hide_entity: true
    initial_state: true
    trigger:
      - platform: state
        entity_id: binary_sensor.julia_home
        from: 'off'
        to: 'on'
      - platform: state
        entity_id: binary_sensor.michael_home
        from: 'off'
        to: 'on'
    action:
      - service: input_select.select_option
        data_template:
          entity_id: "{{ state_attr(trigger.entity_id, 'status_select') }}"
          option: >-
            {% if is_state(state_attr(trigger.entity_id, 'status_select'), 'Departing') %}
              Home
            {% else %}
              Arriving
            {% endif %}
 
  - alias: person_home
    hide_entity: true
    initial_state: true
    trigger:
      - platform: state
        entity_id: input_select.julias_status
        to: 'Arriving'
        for:
          minutes: 10
      - platform: state
        entity_id: input_select.michaels_status
        to: 'Arriving'
        for:
          minutes: 10
    action:
      - service: input_select.select_option
        data_template:
          entity_id: '{{ trigger.entity_id }}'
          option: 'Home'
 
  - alias: person_departing
    hide_entity: true
    initial_state: true
    trigger:
      - platform: state
        entity_id: binary_sensor.julia_home
        from: 'on'
        to: 'off'
      - platform: state
        entity_id: binary_sensor.michael_home
        from: 'on'
        to: 'off'
    action:
      - service: input_select.select_option
        data_template:
          entity_id: "{{ state_attr(trigger.entity_id, 'status_select') }}"
          option: 'Departing'
 
  - alias: person_away
    hide_entity: true
    initial_state: true
    trigger:
      - platform: state
        entity_id: input_select.julias_status
        to: 'Departing'
        for:
          minutes: 10
      - platform: state
        entity_id: input_select.michaels_status
        to: 'Departing'
        for:
          minutes: 10
    action:
      - service: input_select.select_option
        data_template:
          entity_id: '{{ trigger.entity_id }}'
          option: 'Away'
 
  - alias: person_vacation
    hide_entity: true
    initial_state: true
    trigger:
      - platform: state
        entity_id: input_select.julias_status
        to: 'Away'
        for:
          hours: 24
      - platform: state
        entity_id: input_select.michaels_status
        to: 'Away'
        for:
          hours: 24
    action:
      - service: input_select.select_option
        data_template:
          entity_id: '{{ trigger.entity_id }}'
          option: 'Vacation'

################################################
## Device Tracker
################################################

# Device Tracking
# https://www.home-assistant.io/components/device_tracker.bluetooth_tracker/
#device_tracker:
#  - platform: bluetooth_tracker
#    new_device_defaults:
#      track_new_devices: false
#      hide_if_away: false

# https://www.home-assistant.io/components/device_tracker.owntracks/
device_tracker:
  - platform: owntracks
